# 弱网环境照片上传功能设计与实现（五）

### 5.3 照片处理流程

在上传照片前，强化上传管理器会对照片进行处理，包括安全处理和压缩：

```javascript
/**
 * 处理照片
 * 根据当前网络状态和质量设置处理上传前的照片
 * @param {Object} photoInfo 照片信息对象
 * @returns {Promise<Object>} 处理后的照片信息
 */
async processPhoto(photoInfo) {
  if (!photoInfo || !photoInfo.path) {
    return Promise.reject(new Error('照片信息无效'));
  }
  
  try {
    const processedPhoto = {
      ...photoInfo,
      originalPath: photoInfo.path,
      processTime: Date.now()
    };
    
    // 获取当前质量设置
    const qualitySetting = this.getQualitySetting();
    console.log(`[EnhancedUploadManager] 使用 ${this._currentQuality} 质量处理照片`);
    
    // 清理图片元数据(移除GPS等敏感信息)
    const securedPath = await SecurityFilter.cleanImageMetadata(photoInfo.path);
    processedPhoto.securedPath = securedPath;
    
    // 根据质量设置压缩图片
    if (this._currentQuality !== 'high') {
      try {
        // 压缩图片
        const compressResult = await new Promise((resolve, reject) => {
          wx.compressImage({
            src: securedPath,
            quality: qualitySetting.quality,
            success: resolve,
            fail: reject
          });
        });
        
        processedPhoto.tempFilePath = compressResult.tempFilePath;
        processedPhoto.isCompressed = true;
        processedPhoto.compressionQuality = qualitySetting.quality;
      } catch (compressErr) {
        console.error('[EnhancedUploadManager] 压缩照片失败，使用原图：', compressErr);
        processedPhoto.tempFilePath = securedPath;
        processedPhoto.isCompressed = false;
      }
    } else {
      // 高质量模式使用清理后的原图
      processedPhoto.tempFilePath = securedPath;
      processedPhoto.isCompressed = false;
    }
    
    return processedPhoto;
  } catch (err) {
    console.error('[EnhancedUploadManager] 处理照片失败：', err);
    return Promise.reject(err);
  }
}
```

### 5.4 上传照片实现

照片经过处理后，创建上传任务：

```javascript
/**
 * 上传照片
 * @param {String|Object} photo 照片路径或照片信息对象
 * @param {Object} options 上传选项
 * @returns {Promise<Object>} 上传任务信息
 */
async uploadPhoto(photo, options = {}) {
  try {
    // 标准化照片对象
    const photoInfo = typeof photo === 'string' 
      ? { path: photo, size: 0 } 
      : photo;
    
    // 处理照片(根据网络状态压缩等)
    const processedPhoto = await this.processPhoto(photoInfo);
    
    // 准备上传文件信息
    const fileInfo = {
      path: processedPhoto.tempFilePath,
      size: processedPhoto.size || 0,
      name: SecurityFilter.sanitizeFileName(options.fileName || `photo_${Date.now()}.jpg`),
      photoId: processedPhoto.id || options.photoId || `photo_${Date.now()}`
    };
    
    // 准备上传选项
    const uploadOptions = {
      header: options.header || {},
      formData: {
        ...options.formData,
        photoId: fileInfo.photoId,
        quality: this._currentQuality,
        timestamp: Date.now()
      },
      maxRetries: options.maxRetries || 3,
      retryDelay: options.retryDelay || 2000,
      onProgress: (progressInfo, taskId) => {
        // 触发进度事件
        EventBus.emit('upload:progress', {
          taskId,
          photoId: fileInfo.photoId,
          progress: progressInfo.progress,
          totalBytes: fileInfo.size,
          uploadedBytes: Math.floor(fileInfo.size * (progressInfo.progress / 100))
        });
        
        // 调用外部回调
        if (options.onProgress) {
          options.onProgress(progressInfo, taskId);
        }
      },
      onSuccess: (res, taskId) => {
        // 处理响应数据
        let responseData = null;
        try {
          responseData = typeof res.data === 'string' ? JSON.parse(res.data) : res.data;
        } catch (e) {
          responseData = { success: false, message: '响应数据解析失败' };
        }
        
        // 触发完成事件
        EventBus.emit('upload:complete', {
          taskId,
          photoId: fileInfo.photoId,
          response: responseData
        });
        
        // 调用外部回调
        if (options.onSuccess) {
          options.onSuccess(responseData, taskId);
        }
      },
      onError: (err, taskId) => {
        // 触发错误事件
        EventBus.emit('upload:error', {
          taskId,
          photoId: fileInfo.photoId,
          error: err
        });
        
        // 调用外部回调
        if (options.onError) {
          options.onError(err, taskId);
        }
      }
    };
    
    // 创建上传任务
    const taskId = ResumableUploader.createUploadTask(fileInfo, this.uploadUrl, uploadOptions);
    
    // 触发开始事件
    EventBus.emit('upload:start', {
      taskId,
      photoId: fileInfo.photoId,
      fileInfo
    });
    
    return {
      taskId,
      photoId: fileInfo.photoId,
      status: 'created'
    };
  } catch (err) {
    console.error('[EnhancedUploadManager] 创建上传任务失败：', err);
    return Promise.reject(err);
  }
}
```

### 5.5 批量上传照片

支持一次上传多张照片：

```javascript
/**
 * 批量上传照片
 * @param {Array} photos 照片数组
 * @param {Object} options 上传选项
 * @returns {Promise<Array>} 任务信息数组
 */
async uploadPhotos(photos, options = {}) {
  if (!Array.isArray(photos) || photos.length === 0) {
    return [];
  }
  
  try {
    // 批量创建上传任务
    const tasks = [];
    
    for (const photo of photos) {
      try {
        const task = await this.uploadPhoto(photo, options);
        tasks.push(task);
      } catch (err) {
        console.error('[EnhancedUploadManager] 上传照片失败：', err);
        // 继续处理其他照片
      }
    }
    
    return tasks;
  } catch (err) {
    console.error('[EnhancedUploadManager] 批量上传照片失败：', err);
    return Promise.reject(err);
  }
}
``` 