# 弱网环境照片上传功能设计与实现（四）

### 4.2 图片元数据安全处理

图片可能包含GPS位置等敏感信息，安全过滤器提供了清理图片元数据的功能：

```javascript
/**
 * 清理图片元数据
 * 移除敏感信息，如GPS位置等
 * @param {String} imagePath 图片路径
 * @returns {Promise<String>} 处理后的图片路径
 */
cleanImageMetadata(imagePath) {
  return new Promise((resolve, reject) => {
    // 微信小程序环境不支持直接清理图片元数据
    // 使用图片压缩API可以达到类似效果，因为压缩会移除大部分元数据
    wx.compressImage({
      src: imagePath,
      quality: 95, // 保持较高质量
      success: (res) => {
        console.log('[SecurityFilter] 图片元数据清理完成');
        resolve(res.tempFilePath);
      },
      fail: (err) => {
        console.error('[SecurityFilter] 图片元数据清理失败:', err);
        // 如果失败，返回原始路径
        resolve(imagePath);
      }
    });
  });
}
```

### 4.3 图片内容验证

上传前验证图片内容的安全性，包括文件大小和尺寸：

```javascript
/**
 * 检验图片内容是否安全（大小和尺寸）
 * @param {String} imagePath 图片路径
 * @param {Object} options 选项 {maxSize, maxWidth, maxHeight}
 * @returns {Promise<Object>} 验证结果 {safe, reason, info}
 */
validateImageContent(imagePath, options = {}) {
  const maxSize = options.maxSize || 10 * 1024 * 1024; // 默认10MB
  const maxWidth = options.maxWidth || 4096; // 默认最大宽度
  const maxHeight = options.maxHeight || 4096; // 默认最大高度
  
  return new Promise((resolve) => {
    // 获取文件信息
    wx.getFileInfo({
      filePath: imagePath,
      success: (fileInfo) => {
        // 检查文件大小
        if (!this.isFileSizeAllowed(fileInfo.size, maxSize)) {
          resolve({
            safe: false,
            reason: 'size_exceeded',
            info: {
              size: fileInfo.size,
              maxSize: maxSize
            }
          });
          return;
        }
        
        // 获取图片信息
        wx.getImageInfo({
          src: imagePath,
          success: (imgInfo) => {
            // 检查图片尺寸
            if (imgInfo.width > maxWidth || imgInfo.height > maxHeight) {
              resolve({
                safe: false,
                reason: 'dimensions_exceeded',
                info: {
                  width: imgInfo.width,
                  height: imgInfo.height,
                  maxWidth: maxWidth,
                  maxHeight: maxHeight
                }
              });
              return;
            }
            
            // 一切正常
            resolve({
              safe: true,
              info: {
                size: fileInfo.size,
                width: imgInfo.width,
                height: imgInfo.height,
                type: imgInfo.type
              }
            });
          },
          fail: (err) => {
            console.error('[SecurityFilter] 获取图片信息失败:', err);
            resolve({
              safe: false,
              reason: 'invalid_image',
              info: {
                error: err
              }
            });
          }
        });
      }
    });
  });
}
```

## 5. 强化上传管理器实现

强化上传管理器整合了断点续传上传器、网络监控器和安全过滤器，提供一个统一的接口。

### 5.1 初始化与网络监控设置

```javascript
/**
 * 初始化上传管理器
 * @returns {Object} 当前实例
 */
init(options = {}) {
  console.log('[EnhancedUploadManager] 初始化强化版上传管理器');
  
  // 设置上传URL
  if (options.uploadUrl) {
    this.uploadUrl = options.uploadUrl;
  }
  
  // 初始化断点续传上传器
  ResumableUploader.init();
  
  // 初始化网络监控
  NetworkMonitor.init();
  
  // 监听网络变化并调整上传策略
  this._setupNetworkMonitor();
  
  // 监听上传状态变化
  this._setupUploadListeners();
  
  return this;
}

/**
 * 监听网络状态变化
 * @private
 */
_setupNetworkMonitor() {
  NetworkMonitor.onNetworkChange(state => {
    this._adjustUploadStrategy(state);
  });
}
```

### 5.2 上传策略自适应调整

根据当前网络状态自动调整上传质量和并发数：

```javascript
/**
 * 根据网络状态调整上传策略
 * @param {Object} networkState 网络状态
 * @private
 */
_adjustUploadStrategy(networkState) {
  // 默认使用中等质量
  let qualityLevel = 'medium';
  
  if (!networkState.connected) {
    console.log('[EnhancedUploadManager] 网络已断开，暂停所有上传');
    return;
  }
  
  // 根据网络类型调整质量
  switch (networkState.networkType) {
    case 'wifi':
      qualityLevel = 'high';
      break;
    case '4g':
      qualityLevel = 'medium';
      break;
    case '3g':
      qualityLevel = 'low';
      break;
    case '2g':
      qualityLevel = 'minimum';
      break;
    default:
      // 未知网络类型，使用中等质量
      qualityLevel = 'medium';
  }
  
  // 如果是弱网络环境，降低一级质量
  if (networkState.signalStrength === 'weak') {
    if (qualityLevel === 'high') {
      qualityLevel = 'medium';
    } else if (qualityLevel === 'medium') {
      qualityLevel = 'low';
    } else if (qualityLevel === 'low') {
      qualityLevel = 'minimum';
    }
  }
  
  // 设置当前质量级别
  this.setQuality(qualityLevel);
  
  console.log(`[EnhancedUploadManager] 网络状态: ${networkState.networkType}, 信号: ${networkState.signalStrength}, 设置质量: ${qualityLevel}`);
}
``` 