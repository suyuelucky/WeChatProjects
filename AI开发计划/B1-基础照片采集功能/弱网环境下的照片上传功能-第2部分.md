# 弱网环境照片上传功能设计与实现（二）

### 2.2 网络监控实现详解

网络监控器通过 wx.getNetworkType 和 wx.onNetworkStatusChange API 实现实时监控网络状态，并提供网络状态变化通知机制。

```javascript
/**
 * 初始化网络监控
 * @returns {Object} 当前实例
 */
init() {
  if (this._isInitialized) {
    return this;
  }
  
  // 立即检查一次网络状态
  this._checkNetworkStatus();
  
  // 监听网络变化事件
  this._setupNetworkListener();
  
  // 定时检查网络状态 (每15秒)
  this._startPeriodicCheck();
  
  this._isInitialized = true;
  console.log('[NetworkMonitor] 网络监控初始化完成');
  
  return this;
}
```

定期检查网络状态，确保网络状态信息的准确性：

```javascript
/**
 * 检查网络状态
 * @private
 */
_checkNetworkStatus() {
  wx.getNetworkType({
    success: res => {
      // 更新网络状态
      const isConnected = res.networkType !== 'none';
      
      // 评估信号强度
      let signalStrength = 'normal';
      if (res.networkType === 'wifi') {
        signalStrength = 'strong';
      } else if (res.networkType === '2g') {
        signalStrength = 'weak';
      }
      
      // 更新状态
      this._updateNetworkState({
        connected: isConnected,
        networkType: res.networkType,
        lastCheckTime: Date.now(),
        signalStrength: signalStrength
      });
    }
  });
}
```

### 2.3 网络状态变化通知机制

监听器采用观察者模式，允许多个组件注册网络状态变化回调：

```javascript
/**
 * 注册网络变化监听器
 * @param {Function} callback 回调函数
 * @returns {Function} 取消监听的函数
 */
onNetworkChange(callback) {
  if (typeof callback !== 'function') {
    console.error('[NetworkMonitor] 网络变化回调必须是函数');
    return () => {};
  }
  
  // 确保监控已初始化
  if (!this._isInitialized) {
    this.init();
  }
  
  // 添加到回调列表
  this._changeCallbacks.push(callback);
  
  // 立即用当前状态调用一次
  try {
    callback({ ...this._networkState });
  } catch (err) {
    console.error('[NetworkMonitor] 执行初始网络回调出错:', err);
  }
  
  // 返回取消监听的函数
  return () => {
    this._changeCallbacks = this._changeCallbacks.filter(cb => cb !== callback);
  };
}
```

## 3. 断点续传上传器

断点续传上传器是弱网环境上传的核心组件，负责实现上传任务的创建、暂停、恢复和进度跟踪。

### 3.1 上传任务数据结构

```javascript
// 上传任务对象结构
const task = {
  id: taskId,           // 任务ID
  file: {               // 文件信息
    path: filePath,     // 文件路径
    size: fileSize,     // 文件大小
    name: fileName      // 文件名
  },
  url: uploadUrl,       // 上传URL
  options: options,     // 上传选项
  progress: 0,          // 上传进度(0-100)
  uploaded: 0,          // 已上传字节数
  size: fileSize,       // 文件总大小
  status: 'pending',    // 任务状态: pending, uploading, paused, completed, error
  createTime: Date.now(), // 创建时间
  lastUpdateTime: Date.now(), // 最后更新时间
  error: null,          // 错误信息
  retryCount: 0         // 重试次数
};
``` 