# 弹性上传组件使用指南

## 1. 组件简介

弹性上传组件（ResilientUploader）是专为弱网环境设计的照片上传解决方案，具有以下特点：

- 断点续传：网络中断后可从断点处继续上传
- 自适应质量：根据网络状态自动调整照片质量
- 网络监控：实时监测网络状态并调整策略
- 安全处理：上传前清理照片元数据

## 2. 快速开始

### 2.1 引入组件

在页面的 JSON 文件中声明使用组件：

```json
{
  "usingComponents": {
    "resilient-uploader": "/components/resilient-uploader/resilient-uploader"
  }
}
```

### 2.2 页面中使用

在 WXML 中添加组件：

```html
<resilient-uploader 
  resumable="{{true}}" 
  maxRetries="{{3}}" 
  maxCount="{{9}}" 
  showProgress="{{true}}" 
  autoUpload="{{false}}" 
  uploadUrl="{{uploadUrl}}"
  bind:uploadstart="onUploadStart"
  bind:uploadcomplete="onUploadComplete"
  bind:uploaderror="onUploadError"
  bind:networkchange="onNetworkChange"
/>
```

### 2.3 处理回调事件

在页面的 JS 文件中处理组件回调：

```javascript
Page({
  data: {
    uploadUrl: 'https://your-api-endpoint.com/upload'
  },
  
  onUploadStart(e) {
    console.log('开始上传照片', e.detail);
  },
  
  onUploadComplete(e) {
    console.log('照片上传完成', e.detail);
  },
  
  onUploadError(e) {
    console.log('照片上传失败', e.detail);
  },
  
  onNetworkChange(e) {
    console.log('网络状态变化', e.detail);
  }
})
```

## 3. 组件属性说明

| 属性名      | 类型    | 默认值  | 说明                             |
|------------|---------|--------|----------------------------------|
| resumable  | Boolean | true   | 是否启用断点续传                   |
| maxRetries | Number  | 3      | 上传失败后的最大重试次数            |
| maxCount   | Number  | 9      | 一次最多可选择的照片数量            |
| showProgress | Boolean | true | 是否显示上传进度                   |
| autoUpload | Boolean | false  | 选择照片后是否自动开始上传         |
| uploadUrl  | String  | ''     | 服务器上传接口地址                 |

## 4. 事件说明

| 事件名          | 说明                 | 回调参数                           |
|----------------|---------------------|-----------------------------------|
| photochoose    | 选择照片时触发        | { photos: [...] }                 |
| uploadstart    | 开始上传时触发        | { photoId, taskId }               |
| uploadprogress | 上传进度更新时触发     | { photoId, taskId, progress }     |
| uploadcomplete | 上传完成时触发        | { photoId, taskId, response }     |
| uploaderror    | 上传出错时触发        | { photoId, taskId, error }        |
| networkchange  | 网络状态变化时触发     | { connected, networkType, signalStrength } |

## 5. 组件方法

组件实例提供以下方法，可通过 selectComponent 调用：

| 方法名          | 说明                       | 参数                      |
|----------------|---------------------------|---------------------------|
| choosePhoto    | 选择照片                    | 无                        |
| startUpload    | 开始上传所有待上传照片        | 无                        |
| pauseAllUploads | 暂停所有上传任务            | 无                        |
| resumeAllUploads | 恢复所有暂停的上传任务      | 无                        |
| retryFailedUploads | 重试所有失败的上传任务    | 无                        |
| cancelUpload   | 取消指定的上传任务           | taskId                    |
| clearUploaded  | 清除已上传完成的照片记录      | 无                        |

## 6. 使用示例

### 6.1 手动控制上传

```javascript
Page({
  data: {
    uploadUrl: 'https://example.com/upload'
  },
  
  // 选择照片
  handleChoosePhoto() {
    this.selectComponent('#uploader').choosePhoto();
  },
  
  // 开始上传
  handleStartUpload() {
    this.selectComponent('#uploader').startUpload();
  },
  
  // 暂停上传
  handlePauseUpload() {
    this.selectComponent('#uploader').pauseAllUploads();
  },
  
  // 恢复上传
  handleResumeUpload() {
    this.selectComponent('#uploader').resumeAllUploads();
  }
})
```

```html
<resilient-uploader id="uploader" uploadUrl="{{uploadUrl}}" />

<view class="buttons">
  <button bindtap="handleChoosePhoto">选择照片</button>
  <button bindtap="handleStartUpload">开始上传</button>
  <button bindtap="handlePauseUpload">暂停上传</button>
  <button bindtap="handleResumeUpload">恢复上传</button>
</view>
```

### 6.2 自动上传模式

```html
<resilient-uploader 
  uploadUrl="{{uploadUrl}}" 
  autoUpload="{{true}}" 
  bind:uploadcomplete="onUploadComplete" 
/>
```

## 7. 最佳实践

1. **定制上传策略**：根据业务场景调整 `resumable` 和 `maxRetries` 参数
2. **处理错误**：始终监听 `uploaderror` 事件并给予用户反馈
3. **网络提示**：利用 `networkchange` 事件提示用户当前网络状态
4. **服务端适配**：确保服务端支持断点续传和分片上传
5. **用户体验**：使用 `showProgress` 属性显示上传进度，提高用户体验

## 8. 常见问题

### 8.1 上传后无法获取服务器返回数据

确保在 `uploadcomplete` 回调中正确解析 `e.detail.response`。

### 8.2 网络切换后上传中断

组件会自动处理网络变化，当网络恢复后会自动继续上传。如果未自动恢复，可调用 `resumeAllUploads()` 方法。

### 8.3 如何限制上传文件大小

组件内部已实现文件大小检查，可修改 `SecurityFilter` 中的 `validateImageContent` 方法参数。

### 8.4 上传速度过慢

检查网络状态，考虑调整质量设置或减少并发上传数量。 