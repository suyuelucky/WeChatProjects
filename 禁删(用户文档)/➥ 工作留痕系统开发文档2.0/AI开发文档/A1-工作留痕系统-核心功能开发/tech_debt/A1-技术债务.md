# A1: 工作留痕系统-核心功能开发 技术债务记录

## 技术债务清单

| 债务ID | 描述 | 影响范围 | 严重程度 | 建议解决时间 | 状态 |
|-------|------|---------|---------|------------|------|
| TD001 | EventBus使用CommonJS模块可能导致循环依赖问题 | 核心组件 | 中 | 2025-04-30前 | 未解决 |
| TD002 | StorageService缺少数据版本迁移机制 | 数据持久化 | 中 | 2025-05-15前 | 未解决 |
| TD003 | 网络同步策略未对大文件传输做优化 | 照片同步 | 低 | 2025-06-30前 | 未解决 |
| TD004 | ES5兼容性限制使用了过多的回调嵌套 | 代码可维护性 | 高 | 2025-04-20前 | 未解决 |
| TD005 | 页面组件复用度不足，存在代码重复 | 页面开发效率 | 中 | 2025-05-30前 | 未解决 |

## 详细描述

### TD001: EventBus使用CommonJS模块可能导致循环依赖问题

**问题描述**：
当前EventBus实现使用了CommonJS模块，多个服务相互引用时可能导致循环依赖问题。在开发过程中，发现TraceService和SyncService之间存在间接循环依赖，在某些情况下可能导致事件监听失效。

**当前解决方案**：
通过使用依赖注入的方式减轻问题，但仍有深层次的循环依赖风险。目前通过事件机制来替代直接依赖，但这种方式增加了代码复杂度和调试难度。

**理想解决方案**：
重构EventBus为单例模式，使用发布订阅模式完全解耦服务间依赖。考虑将EventBus实现为全局可访问的服务，不需要通过依赖注入方式获取。

**解决影响**：
解决此问题可降低系统复杂度，提高代码可维护性，减少潜在的运行时错误和内存泄漏风险。

**所需资源**：
- 工程师时间: 约2人日
- 重构工作: 修改EventBus实现和服务注册机制
- 测试覆盖: 确保现有功能不受影响

**相关代码位置**：
- miniprogram/utils/eventBus.js
- miniprogram/services/container.js
- miniprogram/services/traceService.js
- miniprogram/services/syncService.js

### TD002: StorageService缺少数据版本迁移机制

**问题描述**：
当前StorageService没有实现数据版本管理和迁移机制，这意味着当数据结构发生变化时，没有自动化方案处理已存储的旧格式数据。在未来版本更新中，这可能导致数据不兼容或丢失问题。

**当前解决方案**：
目前采用保守的数据结构设计，尽量避免破坏性变更。在必须更改时，会在代码中添加特定逻辑处理旧数据格式，但这种方式不可持续且容易遗漏边缘情况。

**理想解决方案**：
实现完整的数据版本管理机制，包括:
1. 为所有存储的数据添加版本标记
2. 创建数据迁移注册表，记录各版本间的迁移逻辑
3. 在应用启动时自动检测并执行必要的数据迁移

**解决影响**：
实现此机制将大大提高系统的可扩展性和向后兼容性，降低版本更新带来的数据问题风险，简化未来数据结构变更的开发工作。

**所需资源**：
- 工程师时间: 约3人日
- 设计和实现数据迁移框架
- 为现有数据添加版本信息
- 全面测试各种迁移场景

**相关代码位置**：
- miniprogram/services/storageService.js
- miniprogram/utils/storageUtils.js

### TD003: 网络同步策略未对大文件传输做优化

**问题描述**：
当前同步服务对于照片等大文件的上传没有做专门优化，使用的是同一套同步队列机制。这在网络不稳定或大量照片同时同步时可能导致性能问题和同步失败。

**当前解决方案**：
目前仅对照片做了基本的压缩处理，并使用简单的重试机制应对上传失败情况。没有实现分片上传、断点续传等高级特性。

**理想解决方案**：
设计专门的大文件传输策略，包括:
1. 实现分片上传和断点续传
2. 对不同网络环境自动调整上传策略(如WiFi下批量上传，移动网络下限制同时上传数量)
3. 增加上传优先级管理，允许用户指定重要照片优先同步

**解决影响**：
优化后将显著提高照片同步的成功率和速度，降低网络和电池消耗，提升用户体验，特别是在网络条件不佳时。

**所需资源**：
- 工程师时间: 约4人日
- 实现分片上传和断点续传逻辑
- 改进同步队列以支持优先级和并发控制
- 性能测试和网络条件模拟测试

**相关代码位置**：
- miniprogram/services/syncService.js
- miniprogram/services/photoService.js
- miniprogram/utils/networkUtils.js

### TD004: ES5兼容性限制使用了过多的回调嵌套

**问题描述**：
为了确保微信小程序的兼容性，避免使用ES6+的高级特性，导致代码中存在大量回调嵌套，特别是在处理需要顺序执行的异步操作时。这降低了代码可读性和可维护性，增加了bug风险。

**当前解决方案**：
尝试使用简单的Promise包装和回调组织工具减轻问题，但仍未从根本上解决。关键业务逻辑仍存在较深层次的回调嵌套。

**理想解决方案**：
重构异步处理逻辑，实现以下改进:
1. 创建轻量级Promise工具库，兼容ES5环境
2. 开发专用的异步控制流工具，用更清晰的方式组织顺序操作
3. 使用ES6转ES5工具链，允许开发时使用更现代的语法

**解决影响**：
提高代码可读性和可维护性，减少潜在bug，简化异步逻辑，降低开发和调试难度。

**所需资源**：
- 工程师时间: 约5人日
- 异步工具库开发和测试
- 现有回调代码重构
- 兼容性测试确保在所有目标环境正常工作

**相关代码位置**：
- miniprogram/services/syncService.js
- miniprogram/services/traceService.js
- miniprogram/pages/trace/edit/index.js

### TD005: 页面组件复用度不足，存在代码重复

**问题描述**：
当前实现中，页面组件的复用度不高，特别是在工作记录的列表、编辑和详情页面中存在大量相似但略有不同的UI代码。这增加了维护负担，当需要修改共同UI元素时需要在多处同时更改。

**当前解决方案**：
通过复制粘贴代码块实现功能，在需要变更时手动同步各页面的变化。这种方式容易出错且效率低下。

**理想解决方案**：
重构UI组件以提高复用性:
1. 抽象共用UI组件到独立的自定义组件中
2. 设计更灵活的组件接口，允许通过配置适应不同场景
3. 实现统一的布局和样式系统

**解决影响**：
减少代码重复，提高维护效率，确保UI一致性，加快新功能和页面的开发速度。

**所需资源**：
- 工程师时间: 约3人日
- UI组件库设计和实现
- 现有页面改造，使用新组件
- UI一致性测试

**相关代码位置**：
- miniprogram/pages/trace/index/index.wxml
- miniprogram/pages/trace/edit/index.wxml
- miniprogram/pages/trace/detail/index.wxml

---

创建日期: 2025-04-05
最后更新: 2025-04-05
