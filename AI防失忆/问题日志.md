# 问题日志

## 2023-10-18

### 问题 #1: 相机权限申请流程优化

**问题描述**：
在实现照片采集功能时，发现微信小程序的相机权限申请机制需要特别处理。如果用户首次拒绝相机权限，再次申请时将无法通过代码自动弹出权限申请框，必须引导用户手动前往设置页开启权限。

**影响范围**：
- B1 基础照片采集功能
- 所有需要使用相机的页面

**优先级**：高

**解决方案**：
1. 实现完整的权限检查和处理流程：
   ```javascript
   // 检查相机权限
   wx.authorize({
     scope: 'scope.camera',
     success() {
       // 用户已授权，直接调用相机
       this.initCamera();
     },
     fail() {
       // 用户拒绝授权，引导用户开启权限
       wx.showModal({
         title: '提示',
         content: '需要相机权限才能拍照，请前往设置开启权限',
         confirmText: '去设置',
         success(res) {
           if (res.confirm) {
             wx.openSetting({
               success(settingRes) {
                 if (settingRes.authSetting['scope.camera']) {
                   // 用户在设置页开启了权限
                   this.initCamera();
                 }
               }
             });
           }
         }
       });
     }
   });
   ```

2. 在camera-manager组件中统一处理权限逻辑，避免各页面重复实现
3. 添加友好的权限引导UI，提高用户授权意愿

**解决状态**：已解决

**解决者**：AI开发团队

**解决时间**：2023-10-18

---

### 问题 #2: 低端设备相机预览画面卡顿

**问题描述**：
在测试中发现，低配置安卓设备上使用相机组件时，预览画面可能出现卡顿现象，影响用户体验。

**影响范围**：
- B1 基础照片采集功能
- 低端安卓设备用户

**优先级**：中

**解决方案**：
1. 优化相机参数配置，针对低端设备降低分辨率：
   ```javascript
   // 根据设备性能动态设置相机参数
   const systemInfo = wx.getSystemInfoSync();
   const isLowEndDevice = this.checkIsLowEndDevice(systemInfo);
   
   this.setData({
     cameraConfig: {
       resolution: isLowEndDevice ? 'low' : 'high',
       frameSize: isLowEndDevice ? { width: 720, height: 1280 } : { width: 1080, height: 1920 }
     }
   });
   ```

2. 实现设备性能检测函数：
   ```javascript
   checkIsLowEndDevice(systemInfo) {
     // 根据设备型号、内存、系统版本等信息判断
     const { brand, model, platform } = systemInfo;
     // 已知的低端设备列表
     const lowEndDevices = ['device1', 'device2']; 
     
     if (lowEndDevices.includes(model)) return true;
     // 其他判断逻辑...
     
     return false;
   }
   ```

3. 提供手动画质调节选项，让用户可以自行选择性能与画质平衡点

**解决状态**：部分解决（需进一步优化和测试）

**解决者**：AI开发团队

**解决时间**：2023-10-18

---

### 问题 #3: swiper组件在照片预览中的样式限制

**问题描述**：
使用swiper组件实现照片预览时发现，swiper对自定义样式支持有限，特别是在实现全屏预览和自定义手势操作方面有一定局限。

**影响范围**：
- B1 基础照片采集功能中的照片预览功能

**优先级**：低

**解决方案**：
1. 利用swiper的现有属性最大化定制体验：
   ```html
   <swiper 
     class="preview-swiper"
     indicator-dots="{{photos.length > 1}}"
     indicator-color="rgba(255, 255, 255, 0.3)"
     indicator-active-color="#ffffff"
     duration="300"
     circular="{{true}}"
     current="{{currentPhotoIndex}}"
     bindchange="handleSwiperChange">
     <swiper-item wx:for="{{photos}}" wx:key="index">
       <image src="{{item.path}}" mode="aspectFit" bindtap="toggleControls" />
     </swiper-item>
   </swiper>
   ```

2. 使用动态样式和类控制来模拟更复杂的交互效果
3. 考虑在后续版本中开发更高级的自定义预览组件，但当前版本优先使用swiper保证基本功能和性能

**解决状态**：已采用临时解决方案

**解决者**：AI开发团队

**解决时间**：2023-10-18

---

### 问题 #4: 拍照后临时文件路径管理

**问题描述**：
微信小程序camera组件拍照后返回临时文件路径，这些路径在小程序重启后会失效，导致已拍摄的照片无法显示。

**影响范围**：
- B1 基础照片采集功能中的照片存储和预览

**优先级**：高

**解决方案**：
1. 实现照片路径持久化存储：
   ```javascript
   // 拍照成功后保存照片信息
   handleTakePhotoSuccess(res) {
     const { tempImagePath } = res;
     
     // 保存到当前页面数据
     const newPhotos = [...this.data.photos, {
       id: Date.now().toString(),
       path: tempImagePath,
       createTime: new Date().toISOString()
     }];
     
     this.setData({ photos: newPhotos });
     
     // 同时保存到本地存储
     this.savePhotosToStorage(newPhotos);
   },
   
   // 保存照片数据到本地存储
   savePhotosToStorage(photos) {
     wx.setStorage({
       key: 'capturedPhotos',
       data: photos
     });
   },
   
   // 页面加载时恢复照片数据
   onLoad() {
     wx.getStorage({
       key: 'capturedPhotos',
       success: res => {
         // 检查临时文件是否仍然存在
         this.validatePhotoExistence(res.data);
       },
       fail: () => {
         // 无存储数据，使用空数组
         this.setData({ photos: [] });
       }
     });
   },
   
   // 验证照片文件是否存在
   validatePhotoExistence(photos) {
     const validPhotos = [];
     let validationPromises = photos.map(photo => {
       return new Promise(resolve => {
         wx.getFileInfo({
           filePath: photo.path,
           success: () => {
             validPhotos.push(photo);
             resolve();
           },
           fail: () => {
             // 文件不存在，忽略此照片
             resolve();
           }
         });
       });
     });
     
     Promise.all(validationPromises).then(() => {
       this.setData({ photos: validPhotos });
       // 更新存储中的有效照片
       if (validPhotos.length !== photos.length) {
         this.savePhotosToStorage(validPhotos);
       }
     });
   }
   ```

2. 考虑将重要照片保存到永久路径，避免临时文件失效问题
3. 实现定期清理机制，防止临时文件过多占用存储空间

**解决状态**：已解决

**解决者**：AI开发团队

**解决时间**：2023-10-18

---

## 待解决问题

### 问题 #5: 多设备屏幕适配优化

**问题描述**：
照片预览界面在不同尺寸和比例的设备上可能出现显示不完整或比例失调的情况。

**影响范围**：
- B1 基础照片采集功能
- 使用非主流屏幕尺寸的设备

**优先级**：中

**可能的解决方向**：
1. 使用更灵活的响应式布局
2. 针对不同设备分类制定适配方案
3. 实现动态计算逻辑，根据屏幕尺寸调整关键元素

**计划解决时间**：2023-10-19

---

### 问题 #6: 拍照过程中的内存优化

**问题描述**：
连续拍摄多张高清照片可能导致内存占用过高，在低端设备上可能引起卡顿或崩溃。

**影响范围**：
- B1 基础照片采集功能
- 主要影响低端设备用户

**优先级**：中

**可能的解决方向**：
1. 实现拍照过程中的内存监控
2. 根据设备性能动态调整照片质量
3. 超过阈值时自动清理缓存或建议用户保存当前照片

**计划解决时间**：2023-10-20

---

## 2025-01-06 14:23 云开发极端测试模块开发

### 问题描述

需要对云开发功能进行极端测试，确保在大数据量、高并发以及异常输入等极端情况下系统的稳定性。

### 解决方案

开发了专门的极端测试套件，包含三大模块：

1. **批量操作测试**：测试云函数、数据库和存储在大数据量并发操作下的性能
   - 支持可配置的批量大小（5-50）
   - 支持可配置的并发限制（1-10）
   - 支持可配置的文件大小（50KB-500KB）
   - 实现了批量文件上传、批量数据查询和批量云函数调用测试

2. **数据完整性测试**：测试极端数据条件下存储的完整性
   - 支持超长字符串（最大5MB）存储和读取测试
   - 支持深度嵌套对象（最大50层）存储和读取测试
   - 支持大量字段对象（最大500字段）存储和读取测试
   - 支持特殊字符和边界值测试

3. **错误处理测试**：测试系统在异常情况下的容错能力
   - 支持无效输入处理测试
   - 支持边界条件处理测试
   - 支持网络错误和恢复能力测试
   - 支持权限错误处理测试
   - 实现了自动重试机制和超时控制

每个测试模块都支持参数配置和单独运行，同时提供统一的入口统一管理所有测试。测试结果会以详细的日志和统计数据展示，方便定位问题。

### 关键代码

测试套件位于 `miniprogram/pages/cloud-test/extreme-tests/` 目录，包含以下文件：

- `index.js`：主入口，管理测试运行和配置
- `index.wxml` / `index.wxss`：测试界面
- `batch-operations.js`：批量操作测试实现
- `data-integrity.js`：数据完整性测试实现
- `error-handling.js`：错误处理测试实现

每个测试模块都实现了清理测试数据的功能，避免产生大量垃圾数据。

### 注意事项

1. 极端测试可能会产生大量数据和API调用，需注意微信小程序云开发的配额限制
2. 测试结束后应及时清理测试数据，避免占用存储空间
3. 部分测试可能需要较长时间运行，特别是在高并发和大数据量下
4. 长字符串和深度嵌套对象测试可能触发云开发的限制，如文档大小限制（1MB）

最后更新时间: 2023-10-18 