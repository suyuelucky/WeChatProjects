# 写留痕功能 - 问题日志

> 本文档记录"写留痕"功能开发过程中遇到的问题和解决方案，按时间倒序排列。目的是积累经验，避免重复解决相同问题。

## 问题记录

### 2023-04-05: 相机组件权限处理问题

**问题描述**:  
微信小程序相机组件需要用户授权才能使用，但现有代码没有妥善处理用户拒绝授权的情况，导致用户体验不佳。

**影响范围**:  
相机页面、照片采集功能

**问题原因**:  
1. 未提前检查相机权限状态
2. 权限被拒绝后没有提供友好的提示和引导
3. 没有降级方案(如切换到相册选择)

**解决方案**:  
1. 在进入相机页面前预先检查相机权限
```javascript
wx.getSetting({
  success: (res) => {
    if (!res.authSetting['scope.camera']) {
      // 提前申请权限或提示
    }
  }
})
```

2. 添加权限申请引导，解释为什么需要相机权限
3. 添加权限被拒绝的处理逻辑:
```javascript
camera.onError(function(err) {
  if (err.errMsg.indexOf('auth deny') > -1) {
    wx.showModal({
      title: '需要相机权限',
      content: '请在设置中允许使用相机，或选择从相册选择照片',
      confirmText: '去设置',
      cancelText: '使用相册',
      success: (res) => {
        if (res.confirm) {
          wx.openSetting();
        } else {
          // 切换到相册选择
          wx.chooseMedia({
            mediaType: ['image'],
            sourceType: ['album']
          });
        }
      }
    });
  }
});
```

4. 实现从相册选择照片的降级方案

**解决状态**: 待解决

**相关参考**:  
[微信小程序相机权限文档](https://developers.weixin.qq.com/miniprogram/dev/component/camera.html)

### 2023-04-05: 照片过大导致性能问题

**问题描述**:  
当用户拍摄的照片分辨率较高时，直接展示原图会导致内存占用过高，引起性能问题甚至小程序崩溃。

**影响范围**:  
照片展示、照片管理功能

**问题原因**:  
1. 现代手机相机分辨率很高，单张照片文件可达10MB以上
2. 微信小程序内存限制较严格
3. 没有对照片进行压缩处理

**解决方案**:  
1. 照片拍摄或选择后立即进行压缩处理
```javascript
wx.compressImage({
  src: imagePath,
  quality: 80,
  success: (res) => {
    const compressedImagePath = res.tempFilePath;
    // 使用压缩后的图片...
  }
});
```

2. 实现渐进式加载策略，先加载缩略图，点击后再加载原图
3. 使用canvas进行图像处理和缩放
```javascript
// 在canvas中绘制和处理图像
const ctx = wx.createCanvasContext('imageCanvas');
ctx.drawImage(imagePath, 0, 0, canvasWidth, canvasHeight);
ctx.draw(false, () => {
  wx.canvasToTempFilePath({
    canvasId: 'imageCanvas',
    quality: 0.8,
    success: (res) => {
      const optimizedImagePath = res.tempFilePath;
      // 使用优化后的图片...
    }
  });
});
```

4. 建立图像缓存管理机制，限制内存中的图像数量

**解决状态**: 待解决

**相关参考**:  
[微信小程序图片压缩API](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.compressImage.html)

### 2023-04-05: 网络状态切换导致数据同步问题

**问题描述**:  
当用户在离线状态下使用应用，然后网络恢复时，已创建的数据不会自动同步到云端，导致数据不一致。

**影响范围**:  
数据同步功能、离线使用场景

**问题原因**:  
1. 未监听网络状态变化
2. 缺少离线数据队列管理
3. 网络恢复后没有触发同步操作

**解决方案**:  
1. 添加网络状态监听:
```javascript
wx.onNetworkStatusChange(function(res) {
  if (res.isConnected) {
    // 网络已恢复，执行同步
    syncQueueData();
  }
});
```

2. 实现操作队列机制:
```javascript
// 添加操作到队列
function addToSyncQueue(operation) {
  const queue = wx.getStorageSync('syncQueue') || [];
  queue.push({
    ...operation,
    timestamp: Date.now(),
    status: 'pending'
  });
  wx.setStorageSync('syncQueue', queue);
}

// 处理同步队列
function syncQueueData() {
  const queue = wx.getStorageSync('syncQueue') || [];
  if (queue.length === 0) return;
  
  // 按顺序处理队列中的操作
  processNextOperation(queue, 0);
}
```

3. 添加同步状态指示器，让用户了解同步进度
4. 实现冲突解决机制，处理同步过程中可能的数据冲突

**解决状态**: 待解决

**相关参考**:  
[微信小程序网络状态API](https://developers.weixin.qq.com/miniprogram/dev/api/device/network/wx.onNetworkStatusChange.html)

## 未决问题列表

1. **相机组件权限处理问题** - 优先级: 高
2. **照片过大导致性能问题** - 优先级: 高
3. **网络状态切换导致数据同步问题** - 优先级: 中

## 最后更新

- 文档创建时间: 2023-04-05
- 最后更新时间: 2023-04-05 