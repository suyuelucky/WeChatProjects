# 微信小程序开发要点

> 本文档提供微信小程序开发中的关键知识点和最佳实践，特别关注"写留痕"功能所需的技术要点。

## 基础架构

### 文件结构

小程序包含四种基本文件类型：
- `.js`: 逻辑文件，处理业务逻辑
- `.wxml`: 模板文件，类似HTML，构建页面结构
- `.wxss`: 样式文件，类似CSS，定义页面样式
- `.json`: 配置文件，定义页面或组件配置

基本的页面或组件结构如下：
```
pages/example/
├── index.js         # 页面逻辑
├── index.wxml       # 页面结构
├── index.wxss       # 页面样式
└── index.json       # 页面配置
```

### 生命周期

**应用生命周期**:
- `onLaunch`: 小程序初始化时触发
- `onShow`: 小程序启动或从后台进入前台时触发
- `onHide`: 小程序从前台进入后台时触发
- `onError`: 小程序发生错误时触发

**页面生命周期**:
- `onLoad`: 页面加载时触发，只触发一次
- `onShow`: 页面显示时触发
- `onReady`: 页面初次渲染完成时触发，只触发一次
- `onHide`: 页面隐藏时触发
- `onUnload`: 页面卸载时触发

**组件生命周期**:
- `created`: 组件实例创建时触发
- `attached`: 组件实例进入页面节点树时触发
- `ready`: 组件布局完成后触发
- `moved`: 组件实例被移动到节点树另一位置时触发
- `detached`: 组件实例从页面节点树移除时触发

## 性能优化

### setData优化

`setData`是小程序中影响性能的关键操作，需注意以下几点：

1. **减少调用频率**:
   ```javascript
   // 不推荐
   this.setData({ count: 1 });
   this.setData({ msg: 'hello' });
   
   // 推荐
   this.setData({
     count: 1,
     msg: 'hello'
   });
   ```

2. **只更新必要数据**:
   ```javascript
   // 不推荐
   this.setData({
     array: newArray  // 更新整个数组
   });
   
   // 推荐
   this.setData({
     'array[2]': newValue  // 只更新变化的元素
   });
   ```

3. **合理使用nextTick**:
   ```javascript
   // 将多次setData合并成一次
   Promise.resolve().then(() => {
     this.setData({
       // 多个数据一次更新
     });
   });
   ```

### 渲染优化

1. **合理使用条件渲染**:
   - `wx:if` 适用于不频繁切换的场景，会销毁和重新创建元素
   - `hidden` 适用于频繁切换的场景，只是切换显示状态
   
2. **长列表优化**:
   - 使用虚拟列表，只渲染可视区域的元素
   - 分页加载，避免一次加载过多数据
   - 合理使用 `wx:for` 的 `wx:key`，避免无谓的重渲染

3. **避免过度使用复杂选择器**:
   ```css
   /* 不推荐 */
   .list .item .name {
     color: red;
   }
   
   /* 推荐 */
   .item-name {
     color: red;
   }
   ```

## 组件开发

### 自定义组件

创建自定义组件的基本步骤：

1. **定义组件**:
   ```javascript
   // components/myComponent/index.js
   Component({
     properties: {
       // 组件属性
       title: {
         type: String,
         value: ''
       }
     },
     data: {
       // 组件内部数据
     },
     methods: {
       // 组件方法
     }
   });
   ```

2. **组件配置**:
   ```json
   {
     "component": true,
     "usingComponents": {}
   }
   ```

3. **使用组件**:
   ```json
   // 页面json中引入组件
   {
     "usingComponents": {
       "my-component": "/components/myComponent/index"
     }
   }
   ```
   
   ```html
   <!-- 页面wxml中使用组件 -->
   <my-component title="Hello"></my-component>
   ```

### 组件通信

1. **属性传递**: 父组件向子组件传递数据
   ```html
   <custom-component prop-name="{{value}}"></custom-component>
   ```

2. **事件通信**: 子组件向父组件传递消息
   ```javascript
   // 子组件触发事件
   this.triggerEvent('myevent', { data: value });
   
   // 父组件监听事件
   <custom-component bind:myevent="handleEvent"></custom-component>
   ```

3. **selectComponent**: 父组件获取子组件实例
   ```javascript
   const child = this.selectComponent('#componentId');
   child.methodName();
   ```

4. **behaviors**: 共享组件行为
   ```javascript
   // 定义behavior
   const myBehavior = Behavior({
     // 共享的属性和方法
   });
   
   // 使用behavior
   Component({
     behaviors: [myBehavior]
   });
   ```

## API调用

### 常用API模式

微信小程序API主要有三种调用模式：

1. **同步API**: 直接返回结果
   ```javascript
   const res = wx.getSystemInfoSync();
   console.log(res.windowWidth);
   ```

2. **异步API (回调)**: 通过success/fail/complete回调获取结果
   ```javascript
   wx.chooseImage({
     success: (res) => {
       const tempFilePaths = res.tempFilePaths;
     },
     fail: (err) => {
       console.error(err);
     }
   });
   ```

3. **异步API (Promise)**: 转换为Promise形式
   ```javascript
   wx.chooseImage()
     .then(res => {
       const tempFilePaths = res.tempFilePaths;
     })
     .catch(err => {
       console.error(err);
     });
   ```

### 常见API封装

**网络请求封装**:
```javascript
function request(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      success: (res) => {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data);
        } else {
          reject({
            code: res.statusCode,
            message: res.data.message || '请求失败'
          });
        }
      },
      fail: reject
    });
  });
}
```

**权限检查封装**:
```javascript
function checkPermission(scope) {
  return new Promise((resolve, reject) => {
    wx.getSetting({
      success: (res) => {
        if (res.authSetting[`scope.${scope}`]) {
          resolve(true);
        } else if (res.authSetting[`scope.${scope}`] === false) {
          // 已拒绝授权
          resolve(false);
        } else {
          // 未申请过授权
          wx.authorize({
            scope: `scope.${scope}`,
            success: () => resolve(true),
            fail: () => resolve(false)
          });
        }
      },
      fail: reject
    });
  });
}
```

## 存储管理

### 本地存储

微信小程序提供以下存储API:

1. **同步存储**:
   ```javascript
   // 保存数据
   wx.setStorageSync('key', value);
   
   // 读取数据
   const value = wx.getStorageSync('key');
   
   // 删除数据
   wx.removeStorageSync('key');
   
   // 清除所有数据
   wx.clearStorageSync();
   ```

2. **异步存储**:
   ```javascript
   // 保存数据
   wx.setStorage({
     key: 'key',
     data: value,
     success: function() {
       // 成功回调
     }
   });
   
   // 读取数据
   wx.getStorage({
     key: 'key',
     success: function(res) {
       const value = res.data;
     }
   });
   ```

### 存储限制

微信小程序的存储有以下限制：
- 单个 key 存储的最大数据长度为 1MB
- 所有数据存储上限为 10MB
- 超出限制会导致写入失败

**存储最佳实践**:
- 只存储关键数据，非关键数据使用临时缓存
- 大文件（如图片）使用临时文件系统
- 定期清理不必要的缓存数据
- 使用压缩算法减小数据体积

## 媒体处理

### 照片相关API

1. **拍照和选择照片**:
   ```javascript
   wx.chooseMedia({
     count: 9,
     mediaType: ['image'],
     sourceType: ['album', 'camera'],
     success: (res) => {
       const tempFiles = res.tempFiles;
       // 处理选择的照片
     }
   });
   ```

2. **预览图片**:
   ```javascript
   wx.previewImage({
     current: currentUrl, // 当前显示图片的链接
     urls: imageUrls // 需要预览的图片链接列表
   });
   ```

3. **图片压缩**:
   ```javascript
   wx.compressImage({
     src: filePath, // 图片路径
     quality: 80, // 压缩质量(0-100)
     success: (res) => {
       const compressedPath = res.tempFilePath;
       // 使用压缩后的图片
     }
   });
   ```

4. **获取图片信息**:
   ```javascript
   wx.getImageInfo({
     src: imagePath,
     success: (res) => {
       console.log(res.width, res.height);
       // 使用图片信息
     }
   });
   ```

### Canvas图像处理

使用Canvas进行图像处理的基本步骤：

1. **定义Canvas**:
   ```html
   <canvas type="2d" id="myCanvas" style="width: 300px; height: 200px;"></canvas>
   ```

2. **获取Canvas上下文**:
   ```javascript
   const query = wx.createSelectorQuery();
   query.select('#myCanvas')
     .fields({ node: true, size: true })
     .exec((res) => {
       const canvas = res[0].node;
       const ctx = canvas.getContext('2d');
       // 设置Canvas的实际大小
       canvas.width = res[0].width;
       canvas.height = res[0].height;
     });
   ```

3. **在Canvas上绘制图像**:
   ```javascript
   const img = canvas.createImage();
   img.src = imagePath;
   img.onload = () => {
     ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
     
     // 添加水印
     ctx.font = '20px sans-serif';
     ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
     ctx.fillText('水印文本', 10, 30);
     
     // 输出处理后的图像
     wx.canvasToTempFilePath({
       canvas: canvas,
       success: (res) => {
         const processedImagePath = res.tempFilePath;
         // 使用处理后的图片
       }
     });
   };
   ```

## 位置服务

### 位置获取

1. **获取当前位置**:
   ```javascript
   wx.getLocation({
     type: 'gcj02', // 返回gcj02坐标系的经纬度
     success: (res) => {
       const latitude = res.latitude;
       const longitude = res.longitude;
       // 使用位置信息
     },
     fail: (err) => {
       if (err.errMsg.indexOf('auth deny') > -1) {
         // 处理授权被拒绝的情况
       }
     }
   });
   ```

2. **使用地图选择位置**:
   ```javascript
   wx.chooseLocation({
     success: (res) => {
       const name = res.name; // 位置名称
       const address = res.address; // 详细地址
       const latitude = res.latitude; // 纬度
       const longitude = res.longitude; // 经度
       // 使用选择的位置
     }
   });
   ```

3. **逆地理编码**:
   微信小程序没有直接提供逆地理编码API，需要使用地图API或第三方服务：
   ```javascript
   // 使用腾讯地图API示例
   wx.request({
     url: 'https://apis.map.qq.com/ws/geocoder/v1/',
     data: {
       location: `${latitude},${longitude}`,
       key: 'YOUR_MAP_KEY',
       get_poi: 0
     },
     success: (res) => {
       if (res.data.status === 0) {
         const address = res.data.result.address;
         // 使用地址信息
       }
     }
   });
   ```

### 地图组件使用

1. **基本地图显示**:
   ```html
   <map id="myMap"
        longitude="{{longitude}}"
        latitude="{{latitude}}"
        scale="{{scale}}"
        markers="{{markers}}"
        bindmarkertap="markerTap"
        style="width: 100%; height: 300px;">
   </map>
   ```

2. **地图标记**:
   ```javascript
   Page({
     data: {
       longitude: 116.397390,
       latitude: 39.908860,
       scale: 16,
       markers: [{
         id: 1,
         latitude: 39.908860,
         longitude: 116.397390,
         title: '标记点1'
       }]
     },
     markerTap(e) {
       const markerId = e.markerId;
       // 处理标记点击事件
     }
   });
   ```

## 权限管理

### 常见权限

微信小程序常用权限及其scope值：
- 相机: `scope.camera`
- 位置: `scope.userLocation`
- 相册: `scope.writePhotosAlbum`
- 录音: `scope.record`
- 通讯录: `scope.addressBook`

### 权限处理流程

推荐的权限处理流程：

1. **检查权限状态**:
   ```javascript
   wx.getSetting({
     success: (res) => {
       const authSetting = res.authSetting;
       if (authSetting['scope.camera'] === undefined) {
         // 首次使用，尚未申请授权
       } else if (authSetting['scope.camera'] === false) {
         // 已拒绝授权
       } else {
         // 已授权
       }
     }
   });
   ```

2. **首次申请权限**:
   ```javascript
   wx.authorize({
     scope: 'scope.camera',
     success: () => {
       // 用户同意授权
     },
     fail: () => {
       // 用户拒绝授权
     }
   });
   ```

3. **引导用户重新授权**:
   ```javascript
   wx.showModal({
     title: '需要相机权限',
     content: '拍照功能需要使用您的相机，请在设置中允许使用相机',
     confirmText: '去设置',
     success: (res) => {
       if (res.confirm) {
         wx.openSetting({
           success: (authRes) => {
             if (authRes.authSetting['scope.camera']) {
               // 用户在设置页允许了授权
             }
           }
         });
       }
     }
   });
   ```

## 小程序兼容性

### 版本检测

检测API或组件是否可用：
```javascript
// 检测某个API是否可用
if (wx.canIUse('getSystemInfoSync.return.safeArea')) {
  // 支持安全区域API
}

// 检测某个组件和属性是否可用
if (wx.canIUse('camera')) {
  // 支持相机组件
}
```

### 兼容性处理

针对不同版本的兼容性处理：
```javascript
if (wx.canIUse('chooseMedia')) {
  // 使用新API
  wx.chooseMedia({
    // ...
  });
} else {
  // 使用旧API
  wx.chooseImage({
    // ...
  });
}
```

### 运行环境检测

获取详细的系统信息：
```javascript
const systemInfo = wx.getSystemInfoSync();
const {
  platform,      // 平台，如ios、android
  SDKVersion,    // 微信基础库版本
  version,       // 微信版本号
  system,        // 操作系统版本
  model,         // 手机型号
  windowWidth,   // 窗口宽度
  windowHeight   // 窗口高度
} = systemInfo;
```

## 调试技巧

### 日志和调试

1. **控制台日志**:
   ```javascript
   console.log('普通日志');
   console.info('信息日志');
   console.warn('警告日志');
   console.error('错误日志');
   ```

2. **真机调试**:
   - 开发者工具菜单: "工具" > "真机调试"
   - 手机扫码连接后可在真机上运行和调试

3. **自定义日志库**:
   ```javascript
   const logger = {
     debug: (msg, ...args) => {
       if (__DEV__) console.log(`[DEBUG] ${msg}`, ...args);
     },
     info: (msg, ...args) => {
       console.info(`[INFO] ${msg}`, ...args);
     },
     error: (msg, ...args) => {
       console.error(`[ERROR] ${msg}`, ...args);
       // 可添加上报逻辑
     }
   };
   ```

### 常见调试问题

1. **网络请求问题**:
   - 检查域名是否已在小程序管理后台配置
   - 检查HTTPS证书是否有效
   - 使用抓包工具分析请求和响应

2. **白屏问题**:
   - 检查JS错误
   - 检查生命周期函数是否抛出异常
   - 检查渲染数据是否正确

3. **性能问题**:
   - 使用Performance面板分析渲染性能
   - 检查setData调用频率和数据量
   - 分析内存占用情况

## 最佳实践总结

1. **性能优化**:
   - 减少setData调用次数和数据量
   - 使用分包加载，控制主包大小
   - 优化长列表渲染，考虑虚拟列表
   - 图片资源优化，按需加载

2. **稳定性保障**:
   - 完善的错误处理和异常捕获
   - 网络请求错误处理和重试
   - 关键操作数据备份和恢复机制
   - 完整的日志记录系统

3. **用户体验提升**:
   - 适当的加载提示和骨架屏
   - 优雅的权限申请和处理
   - 离线使用支持和数据同步
   - 针对不同机型的适配

4. **代码质量**:
   - 组件化和模块化设计
   - 统一的代码风格和命名规范
   - 充分的代码注释和文档
   - 适当的自动化测试

## 最后更新

- 文档创建时间: 2023-04-05
- 最后更新时间: 2023-04-05 