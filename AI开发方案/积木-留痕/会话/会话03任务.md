# 会话03任务：照片网格组件与位置服务开发

> 本文档定义会话03需要完成的任务，主要是照片网格组件的开发、位置服务的封装和相册页面的集成。

## 任务概述

本次会话的目标是开发照片网格显示组件，用于多张照片的展示、排序和管理；同时封装位置服务，实现位置获取和显示功能；最后优化相册页面，集成照片网格组件。这些组件和服务将与照片采集组件配合，共同实现"写留痕"的核心功能。

## 任务清单

- [ ] **T008: 照片网格组件开发**
  - [ ] 组件基础结构搭建
  - [ ] 网格布局实现
  - [ ] 照片排序(拖拽)功能
  - [ ] 照片分组功能
  - [ ] 封面图设置

- [ ] **T009: 位置服务封装**
  - [ ] 位置获取与权限处理
  - [ ] 地理编码实现
  - [ ] 位置缓存与管理
  - [ ] 离线位置处理

- [ ] **T010: 位置显示组件开发**
  - [ ] 组件基础结构搭建
  - [ ] 位置信息展示
  - [ ] 地图预览功能

- [ ] **T011: 相册页面集成**
  - [ ] 优化现有相册页面
  - [ ] 集成照片网格组件
  - [ ] 相册照片选择与导入
  - [ ] 位置标记集成

## 必读文档

以下是完成任务所需阅读的文档：

1. [项目清单](../项目清单.md) - 了解总体任务划分和组件关系
2. [组件开发规范](../组件开发规范.md) - 了解组件开发的标准
3. [会话02任务](./会话02任务.md) - 了解照片采集组件的实现细节
4. [相册页面代码](../../miniprogram/pages/diary/album/) - 了解现有相册页面实现

## 按需参考

1. [微信小程序地图API文档](https://developers.weixin.qq.com/miniprogram/dev/component/map.html) - 官方地图组件文档
2. [微信小程序位置API文档](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html) - 位置相关API
3. [Sortable.js文档](https://github.com/SortableJS/Sortable) - 可拖拽排序库参考

## 任务详细说明

### T008: 照片网格组件开发

创建一个用于展示和管理多张照片的网格组件：

#### 1. 组件基础结构

组件目录结构：
```
components/PhotoGrid/
├── index.js         # 组件逻辑
├── index.wxml       # 组件模板
├── index.wxss       # 组件样式
└── index.json       # 组件配置
```

组件需要包含以下属性：
```javascript
properties: {
  // 照片数组
  photos: {
    type: Array,
    value: []
  },
  // 布局方式：网格/列表
  layout: {
    type: String,
    value: 'grid' // 'grid'或'list'
  },
  // 是否允许拖拽排序
  enableSort: {
    type: Boolean,
    value: true
  },
  // 是否允许分组
  enableGroup: {
    type: Boolean,
    value: true
  },
  // 是否允许设置封面
  enableCover: {
    type: Boolean,
    value: true
  }
}
```

#### 2. 网格布局实现

- 实现自适应网格布局
- 优化不同大小照片的显示效果
- 实现照片预览功能

#### 3. 照片排序(拖拽)功能

- 实现照片拖拽排序
- 排序过程中的视觉反馈
- 排序结果的保存和通知

#### 4. 照片分组功能

- 实现照片分组UI
- 最多4张照片合为一组的逻辑
- 分组的展开与折叠

#### 5. 封面图设置

- 实现封面图标记
- 最多三张封面图的选择
- 封面图优先展示逻辑

### T009: 位置服务封装

封装位置相关功能，提供统一的位置服务：

#### 1. 位置获取与权限处理

- 封装wx.getLocation API
- 处理位置权限请求和存储
- 权限拒绝的优雅降级处理

#### 2. 地理编码实现

- 实现坐标到地址的转换
- 地址到坐标的反向查询
- 地理编码结果的缓存

#### 3. 位置缓存与管理

- 常用位置的本地缓存
- 位置历史记录管理
- 位置数据的自动更新

#### 4. 离线位置处理

- 离线状态下的位置记录策略
- 网络恢复后的位置数据同步
- 位置信息冲突的处理

### T010: 位置显示组件开发

创建一个用于展示位置信息的组件：

#### 1. 组件基础结构

组件目录结构：
```
components/LocationDisplay/
├── index.js         # 组件逻辑
├── index.wxml       # 组件模板
├── index.wxss       # 组件样式
└── index.json       # 组件配置
```

组件需包含以下属性：
```javascript
properties: {
  // 位置信息对象
  location: {
    type: Object,
    value: null
  },
  // 显示模式：简洁/详细
  mode: {
    type: String,
    value: 'simple' // 'simple'或'detailed'
  },
  // 是否显示地图
  showMap: {
    type: Boolean,
    value: false
  }
}
```

#### 2. 位置信息展示

- 位置名称和地址的显示
- 距离计算和显示
- 自动优化位置名称显示长度

#### 3. 地图预览功能

- 集成微信地图组件
- 位置在地图上的标记
- 支持查看更多位置详情

### T011: 相册页面集成

优化现有相册页面并集成照片网格组件：

#### 1. 优化现有相册页面

- 改进相册页面的UI设计
- 优化照片加载性能
- 增强用户操作体验

#### 2. 集成照片网格组件

- 将照片网格组件集成到相册页面
- 实现相册照片的管理和预览
- 优化大量照片的加载和展示

#### 3. 相册照片选择与导入

- 优化照片选择体验
- 支持多选和批量导入
- 导入照片的预处理

#### 4. 位置标记集成

- 集成位置显示组件
- 为照片添加位置标记
- 基于位置的照片分组或筛选

## 完成标准

1. 照片网格组件功能完整，支持排序、分组和封面设置
2. 位置服务稳定，能处理各种权限和网络场景
3. 位置显示组件正确展示位置信息
4. 相册页面集成良好，用户体验流畅
5. 代码符合项目编码规范
6. 组件有完整的文档说明
7. 组件性能良好，特别是大量照片的场景

## 输出物

1. PhotoGrid组件代码
2. 位置服务封装代码
3. LocationDisplay组件代码
4. 优化后的相册页面代码
5. 组件使用文档和示例

## 注意事项

1. 严格遵循微信小程序开发规范
2. 注意位置权限的处理和隐私保护
3. 照片网格的性能优化，特别是大量照片场景
4. 拖拽排序的流畅性和响应速度
5. 完成后及时更新项目清单状态

## 技术参考

### 位置API示例

```javascript
// 获取位置示例
wx.getLocation({
  type: 'gcj02',
  success: (res) => {
    const { latitude, longitude } = res;
    // 处理位置信息...
  },
  fail: (err) => {
    console.error('获取位置失败:', err);
    // 处理错误...
  }
});
```

### 拖拽排序实现参考

```javascript
// 自定义拖拽排序逻辑
onSortStart(e) {
  this.setData({
    sorting: true,
    dragStartIndex: e.currentTarget.dataset.index
  });
},

onSortMove(e) {
  // 计算当前移动到的位置索引
  const currentIndex = this._calculateIndex(e);
  
  if (currentIndex !== this.data.currentIndex) {
    this.setData({
      currentIndex
    });
    
    // 更新排序预览
    this._updateSortPreview();
  }
},

onSortEnd() {
  // 完成排序并保存结果
  const { dragStartIndex, currentIndex } = this.data;
  if (dragStartIndex !== currentIndex) {
    const photos = [...this.data.photos];
    const [movedItem] = photos.splice(dragStartIndex, 1);
    photos.splice(currentIndex, 0, movedItem);
    
    this.setData({
      photos,
      sorting: false
    });
    
    // 触发排序完成事件
    this.triggerEvent('sort', { photos });
  }
}
```

## 最后更新

- 文档创建时间: 2023-04-05
- 最后更新时间: 2023-04-05 