# B1-基础照片采集功能：测试环境配置指南

## 1. 概述

本文档详细说明了执行B1基础照片采集功能极端测试所需的环境配置、工具安装和参数设置。测试团队应严格按照本指南配置测试环境，确保测试结果的准确性和可重现性。

## 2. 硬件要求

### 2.1 测试设备清单

| 设备类型 | 最低配置 | 建议配置 | 数量 | 用途 |
|---------|---------|---------|------|------|
| 高端手机 | 8GB RAM, 128GB存储 | iPhone 14 Pro或同级Android旗舰机 | 2台 | 性能基准测试、高负载测试 |
| 中端手机 | 6GB RAM, 64GB存储 | iPhone SE或中端Android机型 | 2台 | 主流用户环境测试 |
| 低端手机 | 4GB RAM, 32GB存储 | 入门级Android机型 | 2台 | 资源受限环境测试 |
| 平板设备 | iPad或同级Android平板 | iPad Pro或高端Android平板 | 1台 | 大屏幕兼容性测试 |
| 测试用电脑 | i5处理器, 8GB RAM | i7处理器, 16GB RAM | 1台 | 运行测试工具、分析测试数据 |

### 2.2 网络设备需求

- 可配置的路由器（支持带宽限制、QoS设置）
- 网络模拟器（支持延迟、丢包、带宽限制等配置）
- 多种网络环境（WiFi、热点、有线连接）

## 3. 软件环境配置

### 3.1 必要软件安装

| 软件名称 | 版本 | 安装平台 | 下载链接 | 用途 |
|---------|------|---------|---------|------|
| 微信开发者工具 | 最新稳定版 | Windows/macOS | [开发者工具下载](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html) | 小程序调试和模拟 |
| Charles/Proxyman | 最新版 | macOS/Windows | [Charles](https://www.charlesproxy.com/)或[Proxyman](https://proxyman.io/) | 网络请求分析和修改 |
| Network Link Conditioner | 最新版 | macOS/iOS | 通过Xcode安装 | iOS设备网络条件模拟 |
| Clumsy | 最新版 | Windows | [Clumsy](https://jagt.github.io/clumsy/) | 网络丢包、延迟模拟 |
| Wireshark | 最新稳定版 | Windows/macOS | [Wireshark](https://www.wireshark.org/) | 网络流量分析 |
| 性能监控工具 | 设备自带 | iOS/Android | - | 资源使用监控 |
| DB Browser for SQLite | 最新版 | Windows/macOS | [SQLite Browser](https://sqlitebrowser.org/) | 本地数据库分析 |

### 3.2 环境变量与配置

```bash
# 开发环境配置示例
export NODE_ENV=testing
export API_TIMEOUT=60000  # 延长超时时间用于网络测试
export LOG_LEVEL=debug    # 提高日志记录级别
```

### 3.3 微信开发者工具配置

1. **基本设置**
   - 设置本地调试基础库为目标测试版本
   - 启用详细日志记录
   - 启用小程序审查元素
   - 启用代码自动热重载

2. **调试设置**
   - 开启调试模式
   - 启用Network面板记录
   - 启用Console详细日志
   - 设置合适的断点

3. **模拟器配置**
   - 配置多种设备尺寸模拟
   - 设置不同系统版本模拟环境

## 4. 测试数据准备

### 4.1 测试照片集

| 照片类型 | 数量 | 特征 | 用途 |
|---------|------|------|------|
| 标准测试照片 | 20张 | 不同分辨率、正常曝光 | 基础功能测试 |
| 大尺寸照片 | 10张 | >10MB, 高分辨率 | 资源限制测试 |
| 特殊格式照片 | 10张 | 包含HEIC、RAW等格式 | 兼容性测试 |
| 异常照片 | 10张 | 损坏的头部信息、畸形数据等 | 容错性测试 |

测试照片集已保存在：`/测试资源/照片集/`，使用前请复制到测试设备。

### 4.2 预设测试账号

| 账号类型 | 用户名 | 密码 | 权限 | 用途 |
|---------|-------|------|------|------|
| 管理员账号 | admin_test | 详见密码文档 | 全部权限 | 特权操作测试 |
| 普通用户账号 | user_test | 详见密码文档 | 基础权限 | 标准功能测试 |
| 受限账号 | limited_test | 详见密码文档 | 有限权限 | 权限边界测试 |

## 5. 网络环境模拟配置

### 5.1 带宽限制设置

使用Charles或Network Link Conditioner配置以下网络环境：

| 环境名称 | 下载带宽 | 上传带宽 | 用途 |
|---------|---------|---------|------|
| 极慢网络 | 50 Kbps | 20 Kbps | 极端弱网测试 |
| 2G网络 | 250 Kbps | 100 Kbps | 低速网络测试 |
| 3G网络 | 1.5 Mbps | 750 Kbps | 中速网络测试 |
| 4G网络 | 8 Mbps | 2 Mbps | 标准网络测试 |
| WiFi | 20 Mbps | 5 Mbps | 高速网络测试 |

### 5.2 网络延迟设置

| 环境名称 | 延迟值 | 波动范围 | 用途 |
|---------|-------|---------|------|
| 低延迟 | 50ms | ±10ms | 标准环境 |
| 中延迟 | 200ms | ±50ms | 较差网络环境 |
| 高延迟 | 500ms | ±100ms | 恶劣网络环境 |
| 极端延迟 | 1000ms | ±300ms | 极端网络环境 |
| 不稳定延迟 | 300ms | ±250ms | 波动网络环境 |

### 5.3 丢包率设置

使用Clumsy或类似工具配置以下丢包环境：

| 环境名称 | 丢包率 | 模式 | 用途 |
|---------|-------|------|------|
| 轻微丢包 | 5% | 随机 | 轻微网络问题测试 |
| 中度丢包 | 15% | 随机 | 中等网络问题测试 |
| 严重丢包 | 30% | 随机 | 严重网络问题测试 |
| 突发丢包 | 10% | 突发模式 | 网络波动测试 |

### 5.4 网络切换脚本

为模拟频繁的网络环境切换，提供了以下脚本：

```bash
# 网络切换模拟脚本示例
# 使用方法：./network_switch.sh [循环次数]

function toggle_wifi() {
    # 系统特定的WiFi开关命令
    echo "切换WiFi状态"
}

function toggle_cellular() {
    # 系统特定的蜂窝数据开关命令
    echo "切换蜂窝数据状态"
}

# 主循环
count=${1:-5}
for ((i=1; i<=count; i++)); do
    echo "===== 循环 $i/$count ====="
    toggle_wifi
    sleep 3
    toggle_cellular
    sleep 3
    # 更多网络切换逻辑...
done
```

脚本位置：`/测试资源/脚本/network_switch.sh`

## 6. 资源限制模拟配置

### 6.1 内存限制方法

#### iOS设备
- 使用Xcode Instruments的Allocations工具监控内存使用
- 在测试前启动多个后台应用占用内存

#### Android设备
- 使用开发者选项中的"不保留活动"选项
- 使用adb命令限制应用内存：
  ```bash
  adb shell am set-process-limit [package_name] [memory_limit]
  ```

### 6.2 CPU负载模拟

- 在测试设备上并行运行CPU密集型应用（如3D游戏、视频编辑应用）
- 使用专用性能测试应用创建特定CPU负载：
  ```bash
  # 示例：使用stress-ng工具创建CPU负载
  stress-ng --cpu 4 --cpu-load 80 --timeout 60s
  ```

### 6.3 存储空间限制

- 手动填充设备存储空间至所需测试条件
- 使用以下脚本快速创建占用指定空间的文件：
  ```bash
  # 创建指定大小的文件
  # 用法：./fill_storage.sh [size_in_mb]
  dd if=/dev/zero of=./large_file bs=1M count=$1
  ```

### 6.4 电池状态模拟

- 对于iOS设备，使用Xcode的Energy Impact工具
- 对于Android设备，使用Battery Historian工具
- 测试时将设备电量控制在10%以下，并开启低电量模式

## 7. 监控和日志配置

### 7.1 日志收集设置

```javascript
// 配置日志级别和输出
const logger = {
  level: 'debug',  // 测试时设为debug级别
  targets: ['console', 'file'],
  rotation: {
    maxSize: '10MB',
    maxFiles: 5
  },
  format: 'json'
};
```

### 7.2 性能指标监控

使用以下工具收集关键性能指标：

| 指标 | 工具 | 收集频率 | 存储位置 |
|------|------|---------|---------|
| 内存使用 | 系统监控工具 | 5秒/次 | `/测试结果/性能/memory_log.csv` |
| CPU使用率 | 系统监控工具 | 5秒/次 | `/测试结果/性能/cpu_log.csv` |
| 网络流量 | Charles/Wireshark | 持续 | `/测试结果/性能/network_log.pcap` |
| 电池消耗 | 系统电池工具 | 1分钟/次 | `/测试结果/性能/battery_log.csv` |
| 页面加载时间 | 自定义计时器 | 每次加载 | `/测试结果/性能/load_times.csv` |

### 7.3 崩溃日志收集

- iOS: 配置设备连接到Xcode，收集设备日志
- Android: 使用adb logcat收集日志
  ```bash
  adb logcat -v threadtime > crash_log.txt
  ```

## 8. 测试自动化配置

### 8.1 自动化测试框架

| 框架 | 版本 | 适用范围 | 配置文件位置 |
|------|------|---------|------------|
| Jest | 最新版 | 单元测试 | `/测试资源/自动化/jest.config.js` |
| Puppeteer | 最新版 | UI自动化测试 | `/测试资源/自动化/puppeteer.config.js` |
| Appium | 最新版 | 移动设备UI测试 | `/测试资源/自动化/appium.config.js` |

### 8.2 自动化测试脚本示例

```javascript
// 照片连续拍摄测试示例
describe('连续拍照测试', () => {
  const PHOTO_COUNT = 100;
  
  beforeAll(async () => {
    await setupTestEnvironment();
    await navigateToPhotoCapturePage();
  });
  
  test(`连续拍摄${PHOTO_COUNT}张照片测试`, async () => {
    for (let i = 0; i < PHOTO_COUNT; i++) {
      await takePhoto();
      await waitForPhotoSaved();
      
      // 检查内存使用
      const memoryUsage = await getMemoryUsage();
      expect(memoryUsage).toBeLessThan(MAX_MEMORY_THRESHOLD);
      
      console.log(`拍摄照片 ${i+1}/${PHOTO_COUNT}, 内存使用: ${memoryUsage}MB`);
    }
    
    // 验证照片列表
    const photoList = await getPhotoList();
    expect(photoList.length).toEqual(PHOTO_COUNT);
  }, 300000); // 5分钟超时
});
```

## 9. 测试环境验证步骤

在开始正式测试前，请执行以下验证步骤确保测试环境正确配置：

1. **网络环境验证**
   - 使用speedtest.net或类似工具验证带宽限制是否生效
   - 使用ping工具验证网络延迟设置是否正确
   - 使用适当工具确认丢包率设置已生效

2. **设备资源监控验证**
   - 确认内存和CPU监控工具可正常记录数据
   - 验证存储空间限制是否生效
   - 测试电池状态监控是否正常工作

3. **小程序环境验证**
   - 确认测试版本小程序可正常启动
   - 验证日志收集功能是否正常
   - 测试基本照片拍摄功能是否可用

4. **自动化测试验证**
   - 运行简单的自动化测试脚本验证框架配置
   - 确认测试结果收集和报告生成正常

## 10. 常见问题与解决方案

| 问题 | 症状 | 解决方案 |
|------|------|---------|
| 网络限制工具不生效 | 实际网速与设置不符 | 检查代理设置、重启设备，确认证书安装正确 |
| 设备内存监控失败 | 无法获取内存使用数据 | 更新监控工具，确认权限设置，尝试重启设备 |
| 自动化测试失败 | 测试脚本无法找到UI元素 | 检查元素选择器，更新测试脚本，确认UI结构未变更 |
| 日志收集不完整 | 丢失部分关键日志信息 | 增加日志缓冲区大小，提高记录频率，使用多种日志记录方式 |
| 模拟器与真机行为不一致 | 相同测试在不同环境有不同结果 | 优先以真机测试结果为准，记录差异并报告开发团队 |

---

## 附录

### A. 环境配置核对清单

- [ ] 测试设备已准备完毕并已安装最新版本小程序
- [ ] 网络模拟工具已安装并配置各种测试环境
- [ ] 性能监控工具已设置并可正常收集数据
- [ ] 测试数据（照片集、账号等）已准备就绪
- [ ] 日志收集机制已配置并测试通过
- [ ] 自动化测试框架已配置并验证可用
- [ ] 所有团队成员熟悉测试环境和流程

### B. 参考资料

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Charles Proxy文档](https://www.charlesproxy.com/documentation/)
- [Network Link Conditioner使用指南](https://nshipster.com/network-link-conditioner/)
- [Appium文档](https://appium.io/docs/en/about-appium/intro/)

---

创建日期: 2024-04-06
最后更新: 2024-04-06
版本: 1.0
作者: 资方测试团队 