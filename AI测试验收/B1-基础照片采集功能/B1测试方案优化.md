# B1-基础照片采集功能测试方案优化

## 1. 已测试情况总结

根据已执行的4个极端测试用例(RS-MEM-001、RS-MEM-002、XT02-001、XT03-001)，已发现11个关键问题，包括:
- 内存管理问题：连续拍照时内存持续增长，照片浏览无有效内存释放
- 图片处理问题：大图加载策略不合理，未实现分级加载
- 安全性问题：存在XSS注入、SQL注入风险
- 网络处理问题：弱网环境适应性差，缺乏断点续传能力

目前测试进度仅为计划的16%，通过率为0%，亟需补充更多测试场景并解决已发现问题。

## 2. 补充测试场景

### 2.1 内存管理补充测试

| 测试ID | 测试名称 | 优先级 | 测试目标 |
|--------|----------|--------|----------|
| RS-MEM-003 | 大量照片连续删除内存测试 | P0 | 验证在大量照片删除操作下内存回收是否正常 |
| RS-MEM-004 | 内存警告响应测试 | P0 | 验证应用对系统内存警告的响应机制 |
| RS-MEM-005 | 相册切换内存泄露测试 | P1 | 验证在不同相册间快速切换时的内存使用情况 |
| RS-MEM-006 | 后台恢复内存状态测试 | P1 | 验证从后台恢复时应用的内存释放和重建机制 |

### 2.2 照片处理补充测试

| 测试ID | 测试名称 | 优先级 | 测试目标 |
|--------|----------|--------|----------|
| IMG-001 | 超大尺寸照片处理测试 | P0 | 验证对超大分辨率照片(>4K)的处理能力 |
| IMG-002 | HDR和特殊格式照片处理 | P1 | 验证HDR、RAW等特殊格式照片的处理能力 |
| IMG-003 | 照片批量处理性能测试 | P1 | 验证批量处理100+照片时的性能表现 |
| IMG-004 | 损坏照片加载恢复测试 | P2 | 验证应用对部分损坏照片的处理机制 |

### 2.3 安全性补充测试

| 测试ID | 测试名称 | 优先级 | 测试目标 |
|--------|----------|--------|----------|
| SEC-001 | 会话劫持防护测试 | P0 | 验证应用对会话令牌的保护机制 |
| SEC-002 | 敏感数据存储测试 | P0 | 验证用户隐私数据的存储安全性 |
| SEC-003 | URL跳转安全测试 | P1 | 验证URL参数处理的安全性，防止重定向攻击 |
| SEC-004 | 权限提升尝试测试 | P1 | 验证是否可通过参数篡改获取额外权限 |

### 2.4 网络处理补充测试

| 测试ID | 测试名称 | 优先级 | 测试目标 |
|--------|----------|--------|----------|
| NET-001 | 断网-联网循环测试 | P0 | 验证在网络反复中断恢复情况下同步机制 |
| NET-002 | 后台上传持续性测试 | P0 | 验证小程序进入后台时上传任务的持续性 |
| NET-003 | 网络切换稳定性测试 | P1 | 验证在WiFi与移动网络间切换时的处理机制 |
| NET-004 | 大量文件并发上传测试 | P1 | 验证20+文件并发上传时的队列管理和稳定性 |

### 2.5 长时间运行测试

| 测试ID | 测试名称 | 优先级 | 测试目标 |
|--------|----------|--------|----------|
| LNG-001 | 8小时持续运行测试 | P0 | 验证长时间运行下内存增长与稳定性 |
| LNG-002 | 多日定时启动测试 | P1 | 验证连续7天每日启动使用的稳定性 |
| LNG-003 | 热启动性能衰减测试 | P1 | 验证多次热启动后性能是否降低 |

## 3. 测试方法优化

### 3.1 性能监控增强
1. **实时内存使用监控**
   - 使用微信开发者工具Performance面板
   - 添加内存使用日志埋点
   - 记录关键操作前后内存快照对比

2. **API性能分析**
   - 统计各核心API调用频率和耗时
   - 识别低效API调用模式
   - 监控相机API资源占用

3. **UI线程阻塞分析**
   - 添加主线程监控工具
   - 记录长时间(>50ms)任务
   - 生成帧率波动图表

### 3.2 自动化测试工具增强

开发以下自动化辅助工具提高测试效率：

1. **内存压力模拟器**
   - 通过后台任务消耗系统内存
   - 可动态调节可用内存比例
   - 适用iOS和Android平台

2. **网络条件模拟器**
   - 精确控制延迟、丢包率、带宽限制
   - 支持场景预设（地铁、电梯、弱网等）
   - 支持定时切换网络状态

3. **照片生成器**
   - 批量生成不同尺寸、格式的测试照片
   - 生成各类特殊照片（超大、HDR、全黑/白等）
   - 生成特定EXIF数据的照片

4. **极端操作录制器**
   - 记录并回放快速点击、滑动等极端操作
   - 支持随机干扰注入
   - 生成标准操作压力测试脚本

## 4. 重要问题修复建议

### 4.1 内存管理优化

1. **实现分级缓存策略**
   ```javascript
   // 建议实现类似以下的三级缓存策略
   const ImageCache = {
     // 内存中活跃缓存，控制在10张以内
     activeCache: new Map(), 
     // 内存中的非活跃缓存，控制在30张以内
     inactiveCache: new Map(),
     // 本地存储缓存，使用小程序文件系统
     diskCache: {/*...*/},
   
     // 根据系统内存状态动态调整缓存容量
     adjustCacheSize(memoryInfo) {/*...*/},
   
     // 响应内存警告事件
     onMemoryWarning(level) {/*...*/}
   };
   ```

2. **强制垃圾回收机制**
   - 实现主动释放策略
   - 添加关键节点触发回收
   - 长列表滚动优化

### 4.2 图片加载策略优化

1. **实现三级加载策略**
   - 缩略图(200px) → 预览图(800px) → 原图
   - 预加载策略（当前±2张）
   - 内存不足时主动降级

2. **照片压缩处理机制**
   ```javascript
   // 根据设备和内存状态动态调整照片质量
   function getOptimalImageQuality(deviceInfo, memoryInfo, imageSize) {
     // 低内存状态时降低质量
     if (memoryInfo.available < 100 * 1024 * 1024) {
       return 0.7; // 70%质量
     }
     
     // 根据照片大小调整
     if (imageSize > 4 * 1024 * 1024) {
       return 0.8; // 大照片使用80%质量
     }
     
     return 0.9; // 默认90%质量
   }
   ```

### 4.3 安全防护增强

1. **输入过滤与验证**
   ```javascript
   // 安全过滤HTML注入
   function safeStringFilter(input) {
     if (typeof input !== 'string') return input;
     return input
       .replace(/&/g, '&amp;')
       .replace(/</g, '&lt;')
       .replace(/>/g, '&gt;')
       .replace(/"/g, '&quot;')
       .replace(/'/g, '&#039;');
   }
   
   // 长度限制
   function validateInputLength(input, maxLength) {
     if (!input) return true;
     return String(input).length <= maxLength;
   }
   ```

2. **安全存储策略**
   - 敏感数据使用微信提供的加密存储
   - 合理设置小程序权限范围
   - 图片元数据过滤

### 4.4 网络处理增强

1. **断点续传实现**
   ```javascript
   // 分片上传基本结构
   async function uploadLargeFile(filePath) {
     // 获取文件信息
     const fileInfo = await wx.getFileInfo({filePath});
     // 分片大小500KB
     const chunkSize = 500 * 1024; 
     const chunks = Math.ceil(fileInfo.size / chunkSize);
     
     // 上传状态持久化（用于续传）
     const uploadState = await getUploadState(filePath) || {
       uploadedChunks: [],
       uploadId: Date.now().toString()
     };
     
     // 上传所有分片
     for (let i = 0; i < chunks; i++) {
       if (uploadState.uploadedChunks.includes(i)) continue;
       
       try {
         await uploadChunk(filePath, i, chunkSize, uploadState.uploadId);
         uploadState.uploadedChunks.push(i);
         await saveUploadState(filePath, uploadState);
       } catch (error) {
         // 记录错误并支持稍后重试
         console.error('上传分片失败', error);
         return {success: false, state: uploadState};
       }
     }
     
     // 所有分片上传完成，合并请求
     return mergeChunks(uploadState.uploadId, chunks);
   }
   ```

2. **网络状态监听与自适应**
   ```javascript
   // 网络监听
   wx.onNetworkStatusChange(function(res) {
     if (!res.isConnected) {
       // 断网处理，暂停上传队列
       UploadManager.pauseAll();
       wx.showToast({title: '网络已断开，上传已暂停'});
     } else if (res.isConnected && !UploadManager.isRunning()) {
       // 网络恢复，继续上传
       wx.showToast({title: '网络已恢复，继续上传'});
       UploadManager.resumeAll();
     }
     
     // 网络类型变化时调整上传策略
     if (res.networkType === '2g' || res.networkType === '3g') {
       // 弱网络策略：降低并发、增加超时
       UploadManager.setStrategy({
         concurrency: 1,
         timeout: 120000,
         retries: 5
       });
     } else {
       // 强网络策略：增加并发、减少超时
       UploadManager.setStrategy({
         concurrency: 3,
         timeout: 30000,
         retries: 3
       });
     }
   });
   ```

## 5. 测试时间表调整

鉴于已发现的严重问题，建议将测试计划调整如下：

| 阶段 | 调整后日期 | 主要任务 |
|------|-----------|---------|
| 内存管理测试专项 | 2024-04-07 - 04-09 | 执行RS-MEM-003~006，重点验证内存问题修复 |
| 安全性测试专项 | 2024-04-10 - 04-11 | 执行SEC-001~004，专注于安全漏洞排查 |
| 网络测试专项 | 2024-04-12 - 04-13 | 执行NET-001~004，验证网络处理机制 |
| 图片处理测试专项 | 2024-04-14 - 04-15 | 执行IMG-001~004，验证图片处理能力 |
| 长时间运行测试 | 2024-04-16 - 04-18 | 执行LNG-001~003，验证长期稳定性 |
| 集成回归测试 | 2024-04-19 - 04-20 | 综合性回归测试，确认所有问题修复 |

## 6. 总结建议

1. **立即优先解决的问题**
   - 内存管理机制重构（高优先级）
   - XSS/SQL注入安全漏洞修复（高优先级）
   - 分级图片加载策略实现（高优先级）

2. **测试工具增强建议**
   - 开发内存压力和监控工具优先实施
   - 建立自动化性能基准测试流程
   - 增强网络模拟器的精确控制能力

3. **测试流程优化建议**
   - 增加代码扫描环节，提前发现潜在问题
   - 设立专项测试小组针对内存和安全问题
   - 建立极端测试常态化机制，纳入每次迭代

当前B1功能在极端条件下表现不佳，需要系统性重构内存管理、照片处理和网络处理机制，建议停止新功能开发，优先解决当前严重问题。

---

最后更新: 2024-04-07
版本: 1.1
作者: AI测试团队 